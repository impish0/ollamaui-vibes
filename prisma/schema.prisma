// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Chat {
  id             String        @id @default(cuid())
  title          String?       // Max 500 chars, validated by Zod
  model          String        // Last used model (max 200 chars)
  systemPromptId String?
  systemPrompt   SystemPrompt? @relation(fields: [systemPromptId], references: [id], onDelete: SetNull)
  messages       Message[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Indexes for common queries
  @@index([createdAt])
  @@index([updatedAt])
}

model Message {
  id        String   @id @default(cuid())
  chatId    String
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  role      String   // 'user', 'assistant', 'system' (validated by Zod)
  content   String   // Max 100KB (validated by Zod)
  model     String?  // Track which model generated this (max 200 chars)
  createdAt DateTime @default(now())

  // Compound index for efficient chat message queries
  @@index([chatId, createdAt])
  // Index for role-based queries
  @@index([role])
}

model SystemPrompt {
  id        String   @id @default(cuid())
  name      String   @unique // Max 100 chars, alphanumeric + spaces/hyphens (validated by Zod)
  content   String   // Max 10KB (validated by Zod)
  chats     Chat[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([createdAt])
}

model Settings {
  id    String @id @default(cuid())
  key   String @unique
  value String
}

model Collection {
  id          String     @id @default(cuid())
  name        String     @unique // Max 100 chars, validated by Zod
  description String?    // Optional description
  embedding   String     @default("nomic-embed-text") // Embedding model used
  documents   Document[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([name])
  @@index([createdAt])
}

model Document {
  id           String     @id @default(cuid())
  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  filename     String     // Original filename
  contentType  String     // MIME type (e.g., 'text/plain', 'application/pdf')
  content      String     // Extracted text content
  metadata     String?    // JSON string for additional metadata
  chunkCount   Int        @default(0) // Number of chunks created
  status       String     @default("pending") // 'pending', 'processing', 'completed', 'failed'
  errorMessage String?    // Error details if status is 'failed'
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([collectionId, createdAt])
  @@index([status])
}

model PromptLog {
  id                 String   @id @default(cuid())
  chatId             String?  // Optional link to chat
  model              String   // Model used
  messages           String   // Full messages array as JSON
  ragContext         String?  // RAG context injected (if any)
  collectionIds      String?  // JSON array of collection IDs used
  estimatedTokens    Int      // Estimated input tokens
  contextWindowSize  Int      // Context window size used
  responseTokens     Int?     // Response tokens (if available)
  response           String?  // Full response from model
  responseTime       Int?     // Response time in milliseconds
  error              String?  // Error message if failed
  userMessage        String   // The actual user message for easy searching
  createdAt          DateTime @default(now())

  @@index([chatId, createdAt])
  @@index([model])
  @@index([createdAt])
}

// Prompt Version Control Models
model PromptCollection {
  id          String           @id @default(cuid())
  name        String           @unique // Max 100 chars, validated by Zod
  description String?          // Optional description
  color       String?          // Optional color code for UI
  prompts     PromptTemplate[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([name])
  @@index([createdAt])
}

model PromptTemplate {
  id               String            @id @default(cuid())
  name             String            // Max 200 chars, validated by Zod
  description      String?           // Optional description
  collectionId     String?
  collection       PromptCollection? @relation(fields: [collectionId], references: [id], onDelete: SetNull)
  currentVersionId String?           @unique // Points to active version
  versions         PromptVersion[]   @relation("PromptVersions")
  currentVersion   PromptVersion?    @relation("CurrentVersion", fields: [currentVersionId], references: [id], onDelete: SetNull)
  tags             String?           // JSON array of tags for search
  isFavorite       Boolean           @default(false)
  isSystemPrompt   Boolean           @default(false) // Can be used as system prompt in chats
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@unique([name, collectionId]) // Unique name within collection
  @@index([name])
  @@index([collectionId])
  @@index([isFavorite])
  @@index([isSystemPrompt])
  @@index([createdAt])
}

model PromptVersion {
  id                String           @id @default(cuid())
  promptId          String
  prompt            PromptTemplate   @relation("PromptVersions", fields: [promptId], references: [id], onDelete: Cascade)
  content           String           // The actual prompt text (max 50KB)
  variables         String?          // JSON array of variable names found (e.g., ["name", "product"])
  versionNumber     Int              // Incremental version number
  changeDescription String?          // Optional description of what changed
  createdAt         DateTime         @default(now())
  currentVersionOf  PromptTemplate?  @relation("CurrentVersion")

  @@unique([promptId, versionNumber]) // Ensure unique version numbers per prompt
  @@index([promptId, versionNumber])
  @@index([createdAt])
}

// API Provider Management
model Provider {
  id          String   @id @default(cuid())
  name        String   @unique // 'openai', 'anthropic', 'groq', 'google'
  apiKey      String   // Encrypted API key
  enabled     Boolean  @default(true)
  models      String?  // JSON array of available models
  lastTested  DateTime?
  testStatus  String?  // 'success', 'error', null
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([enabled])
}
